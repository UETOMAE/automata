#!/bin/bash

#
# Set environment variables for test implementation
#
BIN_DIR=$(cd $(dirname $0); pwd)
export TEST_ROOT=$(pwd)
export RESOURCES=$(dirname $BIN_DIR)/robotframework/resources
[ -z "$LOCAL_MODE" ] && LOCAL_MODE=false

#
# Read config file
#
CONFIG_FILE=$TEST_ROOT/config
if [ ! -f $CONFIG_FILE ]; then
  echo "You need to create config file '${CONFIG_FILE}'"
  exit 1
fi
. $CONFIG_FILE
if [ -z "$PROJECT_NAME" ]; then
  echo "Missing mandatory environment variable PROJECT_NAME."
  exit 1
fi
if [ "$TARGET_TYPE" != "web" ] && [ "$TARGET_TYPE" != "app" ]; then
  echo "TARGET_TYPE should be 'web' or 'app'."
  exit 1
fi
if [ "$TARGET_TYPE" = "app" ]; then
  if [ -z "$APP_NAME" ]; then
    echo "Missing mandatory environment variable APP_NAME."
    exit 1
  fi
  if [ -z "$APP_VERSION" ]; then
    echo "Missing mandatory environment variable APP_VERSION."
    exit 1
  fi
fi

#
# Source .env file if it exists
#
DOT_ENV_FILE=$TEST_ROOT/.env
if [ -f $DOT_ENV_FILE ]; then
  . $DOT_ENV_FILE
fi

#
# Set environment variables
#
if [ -z "$TEST_RESULTS" ]; then
  export TEST_RESULTS=$TEST_ROOT/results
fi
if [ -z "$TEST_RESOURCES" ]; then
  export TEST_RESOURCES=$TEST_ROOT/resources
fi
if [ -z "$TEST_CASES" ]; then
  export TEST_CASES=$TEST_ROOT/cases
fi

#
# Check diretories
#
if [ ! -d "$TEST_CASES" ]; then
  echo "No test cases exist on '$TEST_CASES'"
  exit 1
fi

#
# Check if browserstack auth information is set if it isn't local mode
#
if [ $LOCAL_MODE == false ]; then
  if [ -z "$BROWSER_STACK_USERNAME" ]; then
    echo "You have to specify environment variable BROWSER_STACK_USERNAME. Use .env file if you need."
    exit 1
  fi

  if [ -z "$BROWSER_STACK_ACCESS_KEY" ]; then
    echo "You have to specify environment variable BROWSER_STACK_ACCESS_KEY. Use .env file if you need."
    exit 1
  fi
fi

#
# Check target environment list on browserstack
#
if [ "$TARGET_TYPE" = "web" ]; then
  . $BIN_DIR/test_automata_env_ua
fi
if [ "$TARGET_TYPE" = "app" ]; then
  . $BIN_DIR/test_automata_env_device
  . $BIN_DIR/test_automata_env_apps
fi
